-- ============================================
-- CREATE ALL 10 TABLES FOR MEDAID CONNECT
-- ============================================

-- 1. EMERGENCIES
CREATE TABLE emergencies (
    emergency_id NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    emergency_code VARCHAR2(20) UNIQUE NOT NULL,
    name VARCHAR2(100) NOT NULL,
    category VARCHAR2(50) NOT NULL,
    severity VARCHAR2(20) DEFAULT 'MEDIUM',
    description VARCHAR2(500),
    avg_response_time NUMBER(5),
    created_date DATE DEFAULT SYSDATE,
    CONSTRAINT chk_severity CHECK (severity IN ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')),
    CONSTRAINT chk_category CHECK (category IN ('MEDICAL', 'TRAUMA', 'ENVIRONMENTAL', 'PEDIATRIC'))
);

-- 2. FIRST_AID_GUIDES
CREATE TABLE first_aid_guides (
    guide_id NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    emergency_id NUMBER(10) NOT NULL,
    step_number NUMBER(3) NOT NULL,
    instruction VARCHAR2(1000) NOT NULL,
    image_url VARCHAR2(200),
    video_url VARCHAR2(200),
    estimated_time NUMBER(5),
    warning VARCHAR2(500),
    created_date DATE DEFAULT SYSDATE,
    modified_date DATE,
    CONSTRAINT fk_guide_emergency FOREIGN KEY (emergency_id) 
        REFERENCES emergencies(emergency_id) ON DELETE CASCADE,
    CONSTRAINT unq_guide_step UNIQUE (emergency_id, step_number),
    CONSTRAINT chk_step_number CHECK (step_number > 0)
);

-- 3. USERS
CREATE TABLE users (
    user_id NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    session_id VARCHAR2(100) UNIQUE,
    age_group VARCHAR2(20),
    gender CHAR(1),
    user_type VARCHAR2(30) DEFAULT 'GENERAL',
    device_type VARCHAR2(20),
    created_date DATE DEFAULT SYSDATE,
    CONSTRAINT chk_gender CHECK (gender IN ('M', 'F', 'O')),
    CONSTRAINT chk_age_group CHECK (age_group IN ('CHILD', 'TEEN', 'ADULT', 'SENIOR')),
    CONSTRAINT chk_user_type CHECK (user_type IN ('GENERAL', 'CAREGIVER', 'MEDICAL_STUDENT', 'TEACHER', 'PARENT'))
);

-- 4. LOCATIONS
CREATE TABLE locations (
    location_id NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    city VARCHAR2(100),
    district VARCHAR2(100),
    province VARCHAR2(100),
    country VARCHAR2(100) DEFAULT 'Rwanda',
    latitude NUMBER(9,6),
    longitude NUMBER(9,6),
    location_type VARCHAR2(50) DEFAULT 'UNKNOWN',
    created_date DATE DEFAULT SYSDATE,
    CONSTRAINT chk_location_type CHECK (location_type IN ('HOME', 'SCHOOL', 'WORK', 'PUBLIC', 'HEALTHCARE', 'UNKNOWN'))
);

-- 5. TIME_DIMENSION
CREATE TABLE time_dimension (
    time_id NUMBER(10) PRIMARY KEY,
    full_date DATE NOT NULL UNIQUE,
    day_of_week NUMBER(1),
    day_name VARCHAR2(10),
    month_number NUMBER(2),
    month_name VARCHAR2(10),
    quarter NUMBER(1),
    year NUMBER(4),
    is_weekend CHAR(1),
    holiday_flag CHAR(1) DEFAULT 'N',
    CONSTRAINT chk_is_weekend CHECK (is_weekend IN ('Y', 'N')),
    CONSTRAINT chk_holiday_flag CHECK (holiday_flag IN ('Y', 'N'))
);

-- 6. GUIDE_USAGE (Main fact table)
CREATE TABLE guide_usage (
    usage_id NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    guide_id NUMBER(10) NOT NULL,
    user_id NUMBER(10) NOT NULL,
    location_id NUMBER(10),
    time_id NUMBER(10),
    usage_date TIMESTAMP DEFAULT SYSTIMESTAMP,
    duration_sec NUMBER(10),
    completed CHAR(1) DEFAULT 'N',
    exit_step NUMBER(3),
    CONSTRAINT fk_usage_guide FOREIGN KEY (guide_id) 
        REFERENCES first_aid_guides(guide_id),
    CONSTRAINT fk_usage_user FOREIGN KEY (user_id) 
        REFERENCES users(user_id),
    CONSTRAINT fk_usage_location FOREIGN KEY (location_id) 
        REFERENCES locations(location_id),
    CONSTRAINT fk_usage_time FOREIGN KEY (time_id) 
        REFERENCES time_dimension(time_id),
    CONSTRAINT chk_completed CHECK (completed IN ('Y', 'N')),
    CONSTRAINT chk_duration CHECK (duration_sec >= 0)
);

-- 7. FEEDBACK
CREATE TABLE feedback (
    feedback_id NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    usage_id NUMBER(10) NOT NULL,
    rating NUMBER(1) NOT NULL,
    helpful CHAR(1) DEFAULT 'Y',
    comment VARCHAR2(1000),
    feedback_date TIMESTAMP DEFAULT SYSTIMESTAMP,
    CONSTRAINT fk_feedback_usage FOREIGN KEY (usage_id) 
        REFERENCES guide_usage(usage_id),
    CONSTRAINT chk_rating CHECK (rating BETWEEN 1 AND 5),
    CONSTRAINT chk_helpful CHECK (helpful IN ('Y', 'N'))
);

-- 8. HOLIDAYS (Phase VII)
CREATE TABLE holidays (
    holiday_id NUMBER(10) PRIMARY KEY,
    holiday_name VARCHAR2(100) NOT NULL,
    holiday_date DATE NOT NULL,
    country VARCHAR2(50) DEFAULT 'Rwanda',
    holiday_type VARCHAR2(30) DEFAULT 'PUBLIC',
    is_recurring CHAR(1) DEFAULT 'Y',
    CONSTRAINT chk_holiday_type CHECK (holiday_type IN ('PUBLIC', 'NATIONAL', 'RELIGIOUS')),
    CONSTRAINT chk_is_recurring CHECK (is_recurring IN ('Y', 'N'))
);

-- 9. SYSTEM_USERS (Phase VII)
CREATE TABLE system_users (
    user_id NUMBER(10) PRIMARY KEY,
    username VARCHAR2(50) NOT NULL,
    user_role VARCHAR2(20) DEFAULT 'USER',
    is_active CHAR(1) DEFAULT 'Y',
    assigned_date DATE DEFAULT SYSDATE,
    CONSTRAINT fk_system_user FOREIGN KEY (user_id) 
        REFERENCES users(user_id),
    CONSTRAINT chk_user_role CHECK (user_role IN ('ADMIN', 'EDITOR', 'VIEWER', 'USER')),
    CONSTRAINT chk_is_active CHECK (is_active IN ('Y', 'N'))
);

-- 10. AUDIT_LOG (Phase VII)
CREATE TABLE audit_log (
    log_id NUMBER(10) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    table_name VARCHAR2(50) NOT NULL,
    operation VARCHAR2(10) NOT NULL,
    record_id NUMBER(10),
    attempted_by VARCHAR2(100) DEFAULT USER,
    attempt_date TIMESTAMP DEFAULT SYSTIMESTAMP,
    status VARCHAR2(20) DEFAULT 'DENIED',
    error_message VARCHAR2(200),
    CONSTRAINT chk_operation CHECK (operation IN ('INSERT', 'UPDATE', 'DELETE')),
    CONSTRAINT chk_status CHECK (status IN ('SUCCESS', 'DENIED', 'ERROR'))
);

-- Create indexes for performance
CREATE INDEX idx_guides_emergency ON first_aid_guides(emergency_id);
CREATE INDEX idx_usage_guide ON guide_usage(guide_id);
CREATE INDEX idx_usage_user ON guide_usage(user_id);
CREATE INDEX idx_usage_date ON guide_usage(usage_date);
CREATE INDEX idx_feedback_usage ON feedback(usage_id);
CREATE INDEX idx_locations_city ON locations(city);

DBMS_OUTPUT.PUT_LINE('All 10 tables created successfully!');